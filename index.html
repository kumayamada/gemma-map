<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ゲムマMAPビューア</title>

<style>
  body {
    margin: 0;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    display: flex;
    height: 100vh;
  }

  #mapWrapper {
    flex: 3;
    overflow: auto;
    background: #eee;
    position: relative;
  }

  /* ▼ マップ箱（1日目 / 2日目 共通） */
  .mapInner {
    position: relative;
    display: none;         /* 最初は非表示 */
    width: 100%;
    max-width: 3451px;
    margin: 0 auto;
  }

  .mapInner.active {
    display: inline-block; /* 選択されたマップだけ表示 */
  }

  /* 画像 */
  .mapInner img {
    display: block;
    max-width: 100%;
    height: auto;
  }

  .booth {
    position: absolute;
    border-radius: 1px;
    border: 0.5px solid #999;
    background: rgba(255,255,255,0.01);
    cursor: pointer;
    transition: 0.2s;
  }

  .booth[data-status="must"]     { background: rgba(255, 80, 80, 0.35); border-color: #ff3b3b; }
  .booth[data-status="maybe"]    { background: rgba(255,210,  0, 0.35); border-color: #e6a700; }
  .booth[data-status="reserved"] { background: rgba(  0,140,255,0.35); border-color: #0090dd; }

  .booth.selected[data-status="must"]     { background: rgba(255,  0,  0,0.75); }
  .booth.selected[data-status="maybe"]    { background: rgba(255,180,  0,0.75); }
  .booth.selected[data-status="reserved"] { background: rgba(  0,120,255,0.75); }

  /* 購入済み */
  .booth[data-state="bought"] { background: rgba(170,170,170,0.9); border-color:#777; }
  .booth[data-state="bought"].selected { background: rgba(140,140,140,0.9); border-color:#555; }

  #panel {
    flex: 1;
    border-left: 1px solid #ccc;
    background: #fafafa;
    padding: 8px;
    overflow: auto;
  }

  /* ▼ パネル内の画像サイズ調整 */
  #panel img {
    max-width: 100%;
    height: auto;
    max-height: 300px;
    object-fit: contain;
    margin-top: 8px;
    border-radius: 4px;
  }

  /* ▼ 日付タブ */
  #dayTabs { display: flex; gap: 10px; margin-bottom: 12px; }
  #dayTabs button {
    flex: 1;
    padding: 10px;
    font-size: 14px;
    border-radius: 10px;
    border: none;
    background: #f0f0f0;
    box-shadow: 4px 4px 8px rgba(0,0,0,0.15),
                -4px -4px 8px rgba(255,255,255,0.85);
    cursor: pointer;
    font-weight: 600;
    color: #333;
    -webkit-appearance: none;
  }
  #dayTabs button.active {
    background: #444;
    color: #fff;
    box-shadow: inset 2px 2px 4px rgba(0,0,0,0.3),
                inset -2px -2px 4px rgba(255,255,255,0.6);
  }

  /* ▼ 検索 */
  #searchBox { display:flex; gap:6px; margin-bottom:8px; }
  #searchInput {
    flex:1; padding:6px 8px; border-radius:8px;
    border:1px solid #ccc; font-size:14px;
  }
  #btnSearch {
    padding:6px 10px; border-radius:8px;
    background:#444; color:#fff; border:1px solid #444;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.35),
                0 1px 4px rgba(0,0,0,0.3);
    cursor:pointer;
  }

  /* ▼ 優先度フィルター */
  #priorityFilter { display:flex; flex-wrap:wrap; gap:6px 12px; margin-bottom:8px; font-size:13px; }
  #priorityFilter label { display:flex; align-items:center; gap:3px; }

  /* ▼ 状態ボタン */
  #stateButtons { display:none; flex-direction:column; gap:10px; margin-top:12px; }
  #stateButtons button {
    width:100%; padding:12px; border-radius:12px; border:none;
    background:#f0f0f0; cursor:pointer; font-size:15px; font-weight:600;
    box-shadow:4px 4px 8px rgba(0,0,0,0.15),
               -4px -4px 8px rgba(255,255,255,0.85);
    color: #333;
    -webkit-appearance: none;
  }
  #stateButtons button.state-on {
    background:#444; color:#fff;
    box-shadow: inset 2px 2px 4px rgba(0,0,0,0.3);
  }

  /* ▼ 座標ラベル */
  #coordDisplay {
    position: fixed;
    bottom: 12px;
    left: 12px;
    background: rgba(0,0,0,0.8);
    color: #fff;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 18px;
    z-index: 9999;
  }

  /* ▼ 選択中ブース用のラベル＆点滅アニメーション */
  .booth-label {
    position: absolute;
    padding: 2px 6px;
    font-size: 11px;
    border-radius: 10px;
    background: rgba(0,0,0,0.8);
    color: #fff;
    transform: translate(-50%, -120%); /* ブースの少し上に出す */
    pointer-events: none;
    white-space: nowrap;
    z-index: 10;
  }

  .booth-flash {
    animation: boothFlash 0.7s ease-out;
  }

  @keyframes boothFlash {
    0% {
      transform: scale(1);
      box-shadow: 0 0 0 0 rgba(255,255,255,0.9);
    }
    60% {
      transform: scale(1.4);
      box-shadow: 0 0 0 12px rgba(255,255,255,0.3);
    }
    100% {
      transform: scale(1);
      box-shadow: 0 0 0 0 rgba(255,255,255,0);
    }
  }

</style>
</head>


<body>

<!-- ▼ 左：マップ -->
<div id="mapWrapper">

  <!-- 1日目 -->
  <div id="mapInner-day1" class="mapInner active">
    <img src="map-day1.png">

    <div class="booth" data-day="1" data-code="L12" data-status="must"
         style="left:53.8%; top:22.8%; width:0.6%; height:0.4%;"></div>

    <div class="booth" data-day="1" data-code="E30" data-status="maybe"
         style="left:18.5%; top:43.6%; width:0.6%; height:0.4%;"></div>

    <div class="booth" data-day="1" data-code="L23" data-status="reserved"
         style="left:43.4%; top:23.7%; width:0.6%; height:0.4%;"></div>
  </div>

  <!-- 2日目 -->
  <div id="mapInner-day2" class="mapInner">
    <img src="map-day2.png">

    <div class="booth" data-day="2" data-code="V6" data-status="must"
         style="left:48.1%; top:60.9%; width:0.6%; height:0.4%;"></div>

    <div class="booth" data-day="2" data-code="E30" data-status="maybe"
         style="left:18.5%; top:43.6%; width:0.6%; height:0.4%;"></div>

    <div class="booth" data-day="2" data-code="L23" data-status="reserved"
         style="left:43.4%; top:23.7%; width:0.6%; height:0.4%;"></div>
  </div>

  <div id="coordDisplay">左右% / 上下%：-</div>
</div>


<!-- ▼ 右：パネル -->
<div id="panel">

  <!-- 日付タブ -->
  <div id="dayTabs">
    <button data-day="1" class="active">1日目</button>
    <button data-day="2">2日目</button>
  </div>

  <!-- 検索 -->
  <div id="searchBox">
    <input id="searchInput" type="text" placeholder="ブース番号（例：L12）">
    <button id="btnSearch">検索</button>
  </div>

  <!-- 優先度フィルター -->
  <div id="priorityFilter">
    <label><input type="checkbox" id="chkMust" checked>必須（赤）</label>
    <label><input type="checkbox" id="chkMaybe" checked>検討（黄）</label>
    <label><input type="checkbox" id="chkReserved" checked>予約済み（青）</label>
  </div>

  <h2>ブースをタップしてください</h2>
  <div id="detail"></div>

  <div id="stateButtons">
    <button id="btnBought">✔ 購入済み</button>
    <button id="btnClear">↩ 元に戻す</button>
  </div>
</div>


<script>
/* ========= ここから JS ========= */

function getActiveMap() {
  return document.querySelector('.mapInner.active');
}

const coordDisp      = document.getElementById("coordDisplay");
const mapWrapper     = document.getElementById("mapWrapper");
const priorityFilter = document.getElementById("priorityFilter");
const stateButtons   = document.getElementById("stateButtons");
const btnBought      = document.getElementById("btnBought");
const btnClear       = document.getElementById("btnClear");

/* ▼ 座標計算（アクティブな地図だけ処理） */
document.addEventListener("click", (e) => {
  const activeMap = getActiveMap();
  if (!activeMap) return;
  if (!activeMap.contains(e.target)) return;

  const r = activeMap.getBoundingClientRect();
  const x = e.clientX - r.left;
  const y = e.clientY - r.top;

  coordDisp.textContent =
    `left:${(x / r.width * 100).toFixed(1)}% / top:${(y / r.height * 100).toFixed(1)}%`;
});

/* ▼ ブース情報 */
const boothData = {
  L12:{circle:"ぺろまる工房",game:"WicFluffy（ウィック・フラフィー）",price:"3,000円",reserve:"済",pickup:"11:00〜12:00",note:"予約名⇒オオタ",image:"PIC_L12.jpg"},
  E30:{circle:"てねずっとgames",game:"大きそうなかぶ",price:"2,000円",reserve:"未",pickup:"",note:"",image:"PIC_E30.jpg"},
  L23:{circle:"茶茶屋",game:"扇舞",price:"4,000円",reserve:"済",pickup:"15:00迄",note:"予約名⇒太田",image:"PIC_L23.jpg"},

  /* ▼ ここから2日目のブース ▼ */
  V6:{circle:"Studio ABC", game:"星くずラビリンス", price:"2,500円", reserve:"未",
      pickup:"", note:"", image:"PIC_A01.jpg"},
  B14:{circle:"オレオレ堂", game:"ハムスター帝国", price:"1,800円", reserve:"済",
      pickup:"13:00〜14:00", note:"予約名⇒オオタ", image:"PIC_B14.jpg"}
};

let currentBooth   = null;
let highlightLabel = null;   // ★ ラベルDOMを覚えておく

/* ▼ ブース詳細表示 */
function showBooth(code){
  currentBooth = code;
  const data = boothData[code];
  if (!data) return;

  document.querySelector("#panel h2").textContent = `【${code}】${data.circle}`;

  let html = `
    <p><strong>ゲーム：</strong>${data.game}</p>
    <p><strong>料金：</strong>${data.price}</p>
    <p><strong>予約：</strong>${data.reserve}</p>
    <p><strong>引取時間：</strong>${data.pickup}</p>
    <p><strong>備考：</strong>${data.note}</p>`;
  if (data.image) html += `<img src="${data.image}">`;

  document.getElementById("detail").innerHTML = html;

  // ボタン表示 & 購入済みボタンの状態更新
  stateButtons.style.display = "flex";
  // 詳細表示中は優先度フィルターを隠す
  priorityFilter.style.display = "none";

  refreshStateButtons();

  // ★ マップ側のハイライト更新（ラベル＋ピカッ）
  updateBoothHighlight(code);
}

/* ▼ 購入済みボタンの見た目更新 */
function refreshStateButtons(){
  btnBought.classList.remove("state-on");
  if (!currentBooth) return;

  const el = document.querySelector(`.booth[data-code="${currentBooth}"]`);
  if (!el) return;

  if (el.dataset.state === "bought") {
    btnBought.classList.add("state-on");
  }
}

/* ▼ 選択中ブースのラベル表示＆一瞬点滅させる */
function updateBoothHighlight(code) {
  const activeMap = getActiveMap();
  if (!activeMap) return;

  const boothEl = activeMap.querySelector(`.booth[data-code="${code}"]`);
  if (!boothEl) return;

  // 既存ラベルを消す
  if (highlightLabel) {
    highlightLabel.remove();
    highlightLabel = null;
  }

  // ラベルを作成
  const label = document.createElement("div");
  label.className = "booth-label";
  label.textContent = code;
  activeMap.appendChild(label);

  // 位置計算：ブースの真ん中あたりの上に配置
  const mapRect   = activeMap.getBoundingClientRect();
  const boothRect = boothEl.getBoundingClientRect();

  const centerX   = boothRect.left + boothRect.width / 2;
  const topY      = boothRect.top;

  const leftPercent = ((centerX - mapRect.left) / mapRect.width) * 100;
  const topPercent  = ((topY    - mapRect.top)  / mapRect.height) * 100;

  label.style.left = leftPercent + "%";
  label.style.top  = topPercent  + "%";

  highlightLabel = label;

  // 一瞬だけ点滅アニメを付ける
  boothEl.classList.remove("booth-flash"); // 付け直し用
  void boothEl.offsetWidth;                // reflow してリセット
  boothEl.classList.add("booth-flash");

  // しばらくしたらクラスを外しておく
  setTimeout(() => {
    boothEl.classList.remove("booth-flash");
  }, 800);
}

/* ▼ 選択解除（詳細を閉じる） */
function clearSelection(){
  document.querySelectorAll(".booth").forEach(b => b.classList.remove("selected"));

  currentBooth = null;

  // ラベルがあれば消す
  if (highlightLabel) {
    highlightLabel.remove();
    highlightLabel = null;
  }

  document.querySelector("#panel h2").textContent = "ブースをタップしてください";
  document.getElementById("detail").innerHTML = "";

  stateButtons.style.display = "none";
  // 何も選択していないときだけ優先度フィルター表示
  priorityFilter.style.display = "flex";

  refreshStateButtons();
}

/* ▼ 余白クリックで選択解除 */
mapWrapper.addEventListener("click", (e) => {
  if (e.target.classList.contains("booth")) return;
  clearSelection();
});

/* ▼ ブースクリック */
document.querySelectorAll(".booth").forEach(el => {
  const saved = localStorage.getItem("state_" + el.dataset.code);
  if (saved) el.dataset.state = saved;

  el.addEventListener("click", () => {
    document.querySelectorAll(".booth").forEach(b => b.classList.remove("selected"));
    el.classList.add("selected");
    showBooth(el.dataset.code);
  });
});

/* ▼ 購入済み/解除 */
btnBought.onclick = () => { if (currentBooth) setState(currentBooth, "bought"); };
btnClear.onclick  = () => { if (currentBooth) setState(currentBooth, "none"); };

function setState(code, state){
  const el = document.querySelector(`.booth[data-code="${code}"]`);
  if (!el) return;

  if (state === "none") {
    el.removeAttribute("data-state");
    localStorage.removeItem("state_" + code);
  } else {
    el.dataset.state = state;
    localStorage.setItem("state_" + code, state);
  }
  if (state === "bought") el.classList.remove("selected");

  refreshStateButtons();
}

/* ▼ 検索 */
const searchInput = document.getElementById("searchInput");
document.getElementById("btnSearch").onclick = () => goToBooth(searchInput.value);

searchInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter") goToBooth(searchInput.value);
});

function goToBooth(raw){
  if (!raw) return;
  const code = raw.trim().toUpperCase();
  const boothEl = document.querySelector(`.booth[data-code="${code}"]`);
  if (!boothEl) {
    alert(`ブース「${code}」は見つかりませんでした`);
    return;
  }

  document.querySelectorAll(".booth").forEach(b => b.classList.remove("selected"));
  boothEl.classList.add("selected");
  showBooth(code);

  boothEl.scrollIntoView({ behavior:"smooth", block:"center", inline:"center" });
}

/* ▼ 日付タブ切替 */
document.querySelectorAll("#dayTabs button").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll("#dayTabs button").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");

    const day = btn.dataset.day;

    document.querySelectorAll(".mapInner").forEach(m => m.classList.remove("active"));
    document.getElementById("mapInner-day" + day).classList.add("active");

    clearSelection();  // 切り替えたら選択解除
  });
});

/* ========= JS 終了 ========= */
</script>

</body>
</html>
